/*! @name videojs-mp3-podcast @version 0.0.1 @license Apache-2.0 */
"use strict";!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("video.js")):"function"==typeof define&&define.amd?define(["video.js"],t):e.videojsMp3PodcastPlugin=t(e.videojs)}(this,function(e){e=e&&e.hasOwnProperty("default")?e.default:e;var t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},o=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},n=function(e){function n(r,a){t(this,n);var i=o(this,e.call(this,r)),s="podcast";if("mp3"===a.type){var l=.5,d=2,c=.25,u="vjs-podcast-header",p="vjs-podcast-buttons",f=r.el().querySelector("audio"),v=a.file,h=f.parentElement,m=U({audioDownloadName:a.audioDownloadName}),y=parseFloat(U({defaultPlaybackRate:a.defaultPlaybackRate}));(!y||y<l||y>d)&&(y=1);var g=U({direction:a.direction}),w=U({downloadButtonText:a.downloadButtonText}),b=U({enableDownload:a.enableDownload}),j=U({enableShare:a.enableShare}),B=U({enableSpeed:a.enableSpeed}),C=U({poweredByLink:a.poweredByLink}),S=U({poweredByLogo:a.poweredByLogo}),T=U({poweredByTitle:a.poweredByTitle}),L=U({progressHolderColor:a.progressHolderColor}),x=U({shareButtonText:a.shareButtonText}),E=U({showConfigPrompt:a.showConfigPrompt}),k=U({speedButtonText:a.speedButtonText}),A=U({themeColor:a.themeColor}),q=U({title:a.title}),D=U({transparentBackground:a.transparentBackground}),O=U({volumeControl:a.volumeControl}),P=U({waveBasedOnAudioBuffer:a.waveBasedOnAudioBuffer});return X("left","User config"),r.options().podcast=Object.assign({},r.options().podcast,{audioDownloadName:m},{defaultPlaybackRate:y},{direction:g},{downloadButtonText:w},{enableDownload:b},{enableShare:j},{enableSpeed:B},{poweredByLink:C},{poweredByLogo:S},{poweredByTitle:T},{progressHolderColor:L},{shareButtonText:x},{showConfigPrompt:E},{speedButtonText:k},{themeColor:A},{title:q},{transparentBackground:D},{volumeControl:O},{waveBasedOnAudioBuffer:P}),X("right","Final config"),F(Object.assign({},{str:"Configured with params: ",obj:r.options().podcast})),f?I():f.addEventListener("load",I),i}function I(){var e;if(f.playbackRate=y,function(){h.classList.add("vjs-podcast"),D&&h.classList.add("vjs-podcast_bg_transparent");for(var e=h.querySelectorAll("button, .vjs-play-progress, .vjs-time-tooltip"),t=0;t<e.length;t++)e[t].style.backgroundColor=A;var o=h.querySelector(".vjs-time-tooltip");o&&(o.style.backgroundColor=A);var n=h.querySelector(".vjs-mouse-display .vjs-time-tooltip");n&&(n.style.color=A)}(),function(){if("rtl"===g){var e=h.querySelector(".vjs-control-bar");e&&e.setAttribute("dir",g);var t=h.querySelector(".vjs-progress-control"),o=t.cloneNode(!0);t.parentNode.replaceChild(o,t);var n=e.querySelector(".vjs-play-progress");if(n){var a=n.querySelector(".vjs-time-tooltip");a&&(a.innerHTML="0:00",a.classList.add("vjs-time-tooltip_rtl"),r.on("timeupdate",function(){a.innerHTML=z(r.currentTime());var e=H(r.currentTime())+"px";a.style.right=e,n.style.width=e}))}var i=e.querySelector(".vjs-mouse-display");if(i){var s=i.querySelector(".vjs-time-tooltip");s&&(s.innerHTML="0:00",s.classList.add("vjs-time-tooltip_rtl"),o.addEventListener("mousemove",function(e){s.innerHTML=z(R(e)),i.style.right=H(R(e))+"px"}))}o.addEventListener("mousedown",function(e){r.currentTime(R(e))}),o.addEventListener("touchstart",function(e){r.currentTime(R(e))})}}(),function(){if(!bowser.msie&&!P)if(W(v)){h.classList.add("vjs-podcast-visualization");var e=0;!function t(){if(h.getBoundingClientRect().width){F("Building random visualization...");for(var o=l(),n=[],r=0;r<o;r++)n.push(Math.random());d(n,!1),d(n,!0),F("Visualisation built.")}else e<50&&setTimeout(function(){e++,t()},50)}()}else h.classList.add("vjs-podcast-no-visualization"),G("Error while building a visualization.");if(!bowser.msie&&P){var t=bowser.safari?new window.webkitAudioContext:new window.AudioContext;if(W(v))fetch(v).then(function(e){return e.arrayBuffer()}).then(function(e){return bowser.safari?new Promise(function(o,n){t.decodeAudioData(e,function(e){o(e)},function(e){n(e)})}):t.decodeAudioData(e)}).then(function(e){return a(e)}).catch(function(e){h.classList.add("vjs-podcast-no-visualization"),G("Error while building a visualization."),console.log(e)});else{var o=v.arrayBuffer(),n=t.decodeAudioData(o);a(n)}}bowser.msie&&h.classList.add("vjs-podcast-no-visualization");function a(e){F("Data was loaded. Starting to build a visualization..."),h.classList.add("vjs-podcast-visualization"),d(s(i(e)),!1),d(s(i(e)),!0),F("Visualisation built.")}function i(e){for(var t=e.getChannelData(0),o=l(),n=Math.floor(t.length/o),r=[],a=0;a<o;a++){for(var i=n*a,s=0,d=0;d<n;d++)s+=Math.abs(t[i+d]);r.push(s/n)}return r}function s(e){function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,n=new Array(t);o<t;o++)n[o]=e[o];return n}var o,n=Math.pow(Math.max.apply(Math,function(e){if(Array.isArray(e))return t(e)}(o=e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(o)||function(e,o){if(e){if("string"==typeof e)return t(e,o);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?t(e,o):void 0}}(o)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),-1);return e.map(function(e){return e*n})}function l(){var e=200,t=h.getBoundingClientRect().width;return t<=1440&&(e=180),t<=1100&&(e=150),t<=850&&(e=120),t<=700&&(e=85),t<=425&&(e=65),t<=300&&(e=45),e}function d(e,t){var o=h.querySelector(".vjs-progress-holder"),n=document.createElement("CANVAS"),a=h.querySelector(".vjs-mp3-canvas-wrapper");if((a=document.createElement("DIV")).classList.add("vjs-mp3-canvas-wrapper"),o.appendChild(a),n.classList.add("vjs-mp3-canvas"),t){a.style.width="0";var i=h.querySelector(".vjs-play-progress");i&&r.on("timeupdate",function(){a.style.width=H(r.currentTime())+"px"})}else n.classList.add("vjs-mp3-canvas_bg");a.append(n);if(t){var s=h.querySelector(".vjs-mp3-canvas_bg");n.width=s.width,n.style.width=s.width+"px",n.height=s.height,window.addEventListener("resize",function(){n.style.width=s.offsetWidth+"px"})}else n.width=1*n.offsetWidth,n.height=1*(n.offsetHeight+16);var l=n.getContext("2d");l.scale(1,1),l.translate(0,n.offsetHeight/2+8);for(var d=n.offsetWidth/e.length,u=0;u<e.length;u++){var p=d*u,f=e[u]*n.offsetHeight-8;f<0?f=0:f>n.offsetHeight/2&&(f=f>n.offsetHeight/2);var v=L;t&&(v=A),c(l,p,f,d,(u+1)%2,v)}D?l.fillStyle="transparent":(l.globalCompositeOperation="xor",l.fillStyle="white"),l.fillRect(0,-n.height/2,n.width,n.height)}function c(e,t,o,n,r,a){e.lineWidth=bowser.mobile?2:2.5,e.strokeStyle=a,e.beginPath(),o=r?o:-o,e.moveTo(t,0),e.lineTo(t,o),e.arc(t+n/2,o,n/2,Math.PI,0,r),e.lineTo(t+n,0),e.stroke()}}(),q||T||S){e=_();var t=document.createElement("DIV");t.classList.add(u),t.setAttribute("dir",g),h.insertBefore(t,f),function(){var e=document.querySelector("."+u),t=document.createElement("DIV");q&&(t.innerText=q,t.style.color=A);e.appendChild(t)}(),function(){if(T||S){var e=document.querySelector("."+u),t=document.createElement("A");if(t.style.color=A,S){var o=document.createElement("IMG");o.src=S,o.alt=T||"",t.appendChild(o)}else T&&(t.innerText=T);C&&(t.href=C,t.style.cursor="pointer"),e.appendChild(t)}}()}if(b||B||j){e||(e=_());var o=document.createElement("DIV");o.classList.add(p),o.setAttribute("dir",g),h.appendChild(o),b&&N(w,"download",3),B&&N(V(),"speed",2),j&&N(x,"share",1)}}function z(e){return e<60?"0:"+M(parseInt(e,10)):e<3600?M(parseInt(e/60,10))+":"+M(parseInt(e%60,10)):parseInt(e/3600,10)+":"+M(parseInt(parseInt(e%3600,10)/60,10))+":"+M(parseInt(parseInt(e%3600,10)%60,10))}function M(e){return e<10?"0"+e:e.toString()}function R(e){var t=h.querySelector(".vjs-progress-control");if(t){var o=t.offsetWidth,n=r.duration(),a=(e.pageX?e.pageX:e.targetTouches[0].pageX)-t.getBoundingClientRect().left;return"ltr"===g?a*n/o:n-a*n/o}}function H(e){var t=h.querySelector(".vjs-progress-control");if(t)return t.offsetWidth*e/r.duration()}function _(){var e=h.parentElement,t=document.createElement("DIV");return t.classList.add("divPlayer_itwplayer-dimensions"),e.appendChild(t),t.appendChild(h),t}function N(e,t,o){var n,r=document.querySelector("."+p);(n=document.createElement("BUTTON")).innerText=e,n.style.borderColor=A,n.style.color=A,o&&(n.style.order=o),r.appendChild(n),n.addEventListener("click",function(e){switch(e.preventDefault(),t){case"download":!function(){F("Download initialized...");var e=new XMLHttpRequest;e.open("GET",v),e.responseType="blob",e.onload=function(){if(200===e.status){var t=document.createElement("a"),o=new Blob([e.response],{type:"audio/mpeg"});bowser.msie?window.navigator.msSaveBlob(o,m):(t.href=window.URL.createObjectURL(o),t.download=m,t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t))}},e.onprogress=function(e){e.lengthComputable?F(Math.round(100*e.loaded/e.total)+"/100 completed!"):F(e.loaded+" bytes were received ;)")},e.onerror=function(){G("Couldn't download the audio.")},e.send()}();break;case"speed":!function(e){y+c<=d?y+=c:y=l;f.playbackRate=y,e.innerText=V()}(n);break;case"share":h.querySelector(".vjs-control-bar button[title=Share]").click()}})}function V(){return k?k+" ×"+y:"×"+y}function W(e){return!!new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i").test(e)}function U(e){var t=Object.keys(e)[0],o=e[t];return void 0===o||""===o&&"speedButtonText"!==t?{audioDownloadName:"podcast.mp3",defaultPlaybackRate:1,direction:"ltr",downloadButtonText:"Download",enableDownload:!1,enableShare:!1,enableSpeed:!1,poweredByLink:"",poweredByLogo:"",poweredByTitle:"",progressHolderColor:"gray",shareButtonText:"Share",showConfigPrompt:!1,speedButtonText:"Speed",themeColor:"#19bc9c",title:"",transparentBackground:!1,volumeControl:!1,waveBasedOnAudioBuffer:!1}[t]:o}function X(e,t){if(E){var o=document.createElement("CODE");o.classList.add("config-prompt"),o.style[e]="10px";for(var n=t+"<br><br><strong>podcast:</strong> {",a=Object.keys(r.options().podcast),i=0;i<a.length;i++)n=n+"<span><strong>"+a[i]+":</strong> "+("string"==typeof r.options().podcast[a[i]]?'"'+r.options().podcast[a[i]]+'"':r.options().podcast[a[i]])+",</span>";n+="}",o.innerHTML=n,h.appendChild(o)}}function F(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"hotpink";function o(e){console.log("%c[".concat(s).concat("] ").concat(e),"color:".concat(t,"; font-weight: bold"))}a.debug&&("string"==typeof e?o(e):(o(e.str),console.log(e.obj)))}function G(e){console.error("[".concat(s).concat("] ").concat(e))}G('Podcast settings are compatible only with {type: "mp3"} config.\n Please, add it to the plugin configuration or remove/comment podcast settings block (podcast: {})')}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(n,e),n}(e.getPlugin("plugin"));return n.VERSION="0.0.1",e.registerPlugin("mp3Podcast",n),n});
